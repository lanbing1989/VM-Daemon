# CS自动化 - 灯火通明（日志监控+自动重启+VM Code 提取+目录记忆+开机自启动+管理员权限）

**当前版本：2.5**

## 简介

本软件为 Windows 平台下的 CS自动化管理工具，具备以下功能：

- **自动监控日志**：实时监控指定目录下的日志文件（log.txt），可根据日志中的异常情况自动重启被控端程序。
- **30分钟无新日志自动重启**：无论任何情况，只要日志30分钟无新内容，自动重启被控端 exe 并推送通知。
- **自动清理同名进程及 Steam/CS:GO**：重启或停止前自动杀死所有同名 exe、steam.exe 和 csgo.exe，避免多实例冲突和游戏未完全关闭。
- **防止自身多开**：程序启动时自动检测是否已运行，如已运行则弹窗提示并自动退出，防止多个守护进程同时运行导致的混乱。
- **VM Code 提取与复制**：自动识别日志中 `[Info] Your code to connect VM: XXXXXXX`，并在界面上显示 VM Code，支持一键复制。
- **记忆文件夹路径**：首次选择被控端 exe 所在文件夹后自动保存，下次启动自动恢复，无需再次选择。
- **简洁易用的 GUI 界面**：提供启动、重启、停止等一站式管理，状态与日志实时展示。
- **开机自启动管理（管理员权限）**：支持一键设置/取消本程序随 Windows 开机自启，采用任务计划方式，自动以管理员权限运行，状态实时显示。
- **自动启动被控端脚本**：开机自启后自动启动被控端 exe（如已配置文件夹）。
- **自带公司版权信息**。

## 使用方法

### 1. 运行环境

- Windows 7/10/11，建议 64 位
- 无需手动安装 Python，直接使用 exe 可执行文件即可

### 2. 启动步骤

1. **首次运行（请使用管理员权限运行）**  
   双击 `CS自动化-灯火通明.exe`。  
   第一次需点击“选择文件夹”选择被控端 exe 所在目录（该目录下应有被控端 exe 文件和 log.txt）。

2. **启动守护**  
   点击“启动”按钮，程序会自动查找最新的 exe 并运行，同时监控 log.txt 日志。

### 3. 自动重启逻辑

- **掉线与异常重启**  
  程序会监控日志文件（log.txt），当出现下列任意异常关键字时，计为一次掉线异常：
    - `Cannot send message. Client is not connected to the server.`
    - `A connection attempt failed because the connected party did not properly respond`
    - `established connection failed because connected host has failed to respond`
    - `TcpClient.EndConnect`
    - `SocketException`
  如果在 60 秒内累计出现三次上述任意异常，程序会自动重启被控端 exe。

- **长时间无响应自动重启**  
  当日志出现 `[CommandDone] StopPlayer done` 后，10 分钟内没有新日志或动作，也会自动重启被控端 exe，防止僵死或假死状态。

- **日志30分钟无新内容自动重启**  
  只要 log.txt 30分钟内没有新内容，无论任何情况，程序会自动重启被控端 exe，并推送 Gotify/Webhook 通知。

- **防止多开**  
  启动时会自动检测是否已有本程序在运行，如检测到则弹窗提示并退出，防止多个实例抢占资源。

- **自动重启过程**  
  自动重启或手动重启/停止时，会自动杀死所有同名 exe 进程，并**额外杀死 steam.exe 和 csgo.exe**，确保不会出现多实例冲突或游戏未关闭。

- **状态显示**  
  每次自动重启会在界面状态栏显示重启次数及最近检测时间，便于追踪异常记录。

- **手动重启**  
  手动点击“重启”按钮也会执行同样的流程（先杀进程，再重启），区别在于不会计入自动重启次数。

- 所有重启过程均为安全操作，确保不会出现僵尸进程或多开异常。

### 4. 其他功能

- **重启**：手动强制重启被控端 exe，同时杀死 steam.exe/csgo.exe。
- **停止**：手动停止所有被控端 exe 实例，同时杀死 steam.exe/csgo.exe。
- **自动生成 config.ini**：程序会自动生成和维护 config.ini 文件，无需手动修改。
- **日志内容实时滚动显示**。
- **支持 Gotify/Webhook 推送**：自动通知各种重启、掉线等事件。
- **网络诊断**：一键检测本地网络、外部网络、服务器连通性与 DNS 解析。

### 5. 开机自启（管理员权限）

- **设置开机自启**  
  点击“设置开机自启”按钮，程序会自动通过任务计划方式，设置本 exe 随 Windows 登录自动以管理员权限运行，无需手动右键或授权。
- **取消开机自启**  
  点击“移除开机自启”即可彻底删除任务计划。
- **开机自启生效说明**  
  采用 Windows 任务计划方式，管理员权限静默启动，无 UAC 弹窗。兼容所有常规自启场景。

### 6. 常见问题

- **无法关闭程序/关不掉**  
  已修复，最新版支持点击关闭按钮完全退出。
- **启动失败/找不到 exe**  
  请确认已正确选择包含 exe 和 log.txt 的文件夹。
- **杀毒误报**  
  因为是自定义打包，可能被部分安全软件误报为风险程序，可自行添加信任或白名单。
- **开机自启后配置未生效**  
  程序已修正，开机自启时也能自动读取同目录下 config.ini 配置文件，无需手动干预。

### 7. 打包说明（如需自行打包）

需先安装 Python 3.x 和依赖（psutil、tkinter 标准库自带），再用以下命令打包：

```bash
pip install pyinstaller
pyinstaller --onefile --noconsole your_script.py
```

无需手动打包 config.ini，程序会自动生成。

---

## 版本历史

- **2.5**
  - 项目重命名为“CS自动化 - 灯火通明”
  - 开机自启方式升级为任务计划（管理员权限自启，静默，无UAC弹窗）
  - 其它功能与2.3保持兼容

- **2.3**
  - 新增：日志30分钟无新内容自动重启，被控端自动重启并推送通知
  - 新增：停止/重启时会同时杀死 steam.exe 和 csgo.exe 进程
  - 新增：防止自身多开，已运行时再次启动会弹窗提示并自动退出
  - 其它功能与 2.2 保持兼容

- **2.2 及更早版本**
  - 支持日志监控、掉线重启、超时重启、VM Code 提取、目录记忆、开机自启、网络诊断、Gotify 推送等

---

## 版权信息

版权所有  灯火通明（济宁）网络有限公司

如有问题可联系技术支持。
