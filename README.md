# 守护进程（日志监控+自动重启+VM Code 提取+目录记忆+开机自启动）

## 简介

本软件为 Windows 平台下的守护进程管理工具，具备以下功能：

- **自动监控日志**：实时监控指定目录下的日志文件（log.txt），可根据日志中的异常情况自动重启被控端程序。
- **自动清理同名进程**：重启前自动杀死所有同名 exe，避免多实例冲突。
- **VM Code 提取与复制**：自动识别日志中 `[Info] Your code to connect VM: XXXXXXX`，并在界面上显示 VM Code，支持一键复制。
- **记忆文件夹路径**：首次选择被控端 exe 所在文件夹后自动保存，下次启动自动恢复，无需再次选择。
- **简洁易用的 GUI 界面**：提供启动、重启、停止等一站式管理，状态与日志实时展示。
- **开机自启动管理**：支持一键设置/取消本程序随 Windows 开机自启，状态实时显示。
- **自动启动被控端脚本**：开机自启后自动启动被控端 exe（如已配置文件夹）。
- **自带公司版权信息**。

## 使用方法

### 1. 运行环境

- Windows 7/10/11，建议 64 位
- 无需手动安装 Python，直接使用 exe 可执行文件即可

### 2. 启动步骤

1. **首次运行**  
   双击 `daemon_guard.exe`。  
   第一次需点击“选择文件夹”选择被控端 exe 所在目录（该目录下应有被控端 exe 文件和 log.txt）。

2. **启动守护**  
   点击“启动”按钮，守护程序会自动查找最新的 exe 并运行，同时监控 log.txt 日志。

### 3. 自动重启逻辑

- **掉线与异常重启**  
  守护程序会监控日志文件（log.txt），当出现下列任意异常关键字时，计为一次掉线异常：
    - `Cannot send message. Client is not connected to the server.`
    - `A connection attempt failed because the connected party did not properly respond`
    - `established connection failed because connected host has failed to respond`
    - `TcpClient.EndConnect`
    - `SocketException`
  如果在 60 秒内累计出现三次上述任意异常，守护进程会自动重启被控端 exe。

- **长时间无响应自动重启**  
  当日志出现 `[CommandDone] StopPlayer done` 后，10 分钟内没有新日志或动作，也会自动重启被控端 exe，防止僵死或假死状态。

- **自动重启过程**  
  自动重启前，会自动杀死所有同名 exe（包括异常遗留的进程），确保不会出现多实例冲突。重启后，守护进程会重新启动最新的被控端 exe，并继续日志监控与守护。

- **状态显示**  
  每次自动重启会在界面状态栏显示重启次数及最近检测时间，便于追踪异常记录。

- **手动重启**  
  手动点击“重启”按钮也会执行同样的流程（先杀进程，再重启），区别在于不会计入自动重启次数。

- 所有重启过程均为安全操作，确保不会出现僵尸进程或多开异常。

### 4. 其他功能

- **重启**：手动强制重启被控端 exe。
- **停止**：手动停止所有被控端 exe 实例。
- **自动生成 config.ini**：程序会自动生成和维护 config.ini 文件，无需手动修改。
- **日志内容实时滚动显示**。

### 5. 常见问题

- **无法关闭程序/关不掉**  
  已修复，最新版支持点击关闭按钮完全退出。
- **启动失败/找不到 exe**  
  请确认已正确选择包含 exe 和 log.txt 的文件夹。
- **杀毒误报**  
  因为是自定义打包，可能被部分安全软件误报为风险程序，可自行添加信任或白名单。
- **开机自启后配置未生效**  
  程序已修正，开机自启时也能自动读取同目录下 config.ini 配置文件，无需手动干预。

### 6. 打包说明（如需自行打包）

需先安装 Python 3.x 和依赖（psutil、tkinter 标准库自带），再用以下命令打包：

```bash
pip install pyinstaller
pyinstaller --onefile --noconsole daemon_guard.py
```

无需手动打包 config.ini，程序会自动生成。

---

## 版权信息

版权所有  灯火通明（济宁）网络有限公司

如有问题可联系技术支持。